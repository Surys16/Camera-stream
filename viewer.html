<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>Game Viewer</title>
<style>
  body {
    background:#111;
    color:#fff;
    font-family:Arial;
    text-align:center;
    padding-top:20px;
  }
  video {
    width:90%;
    border:2px solid #00aaff;
    border-radius:8px;
  }
  button {
    padding:12px 25px;
    font-size:16px;
    margin:12px;
    border:none;
    border-radius:6px;
    cursor:pointer;
    background:#00aaff;
    color:white;
  }
</style>
</head>

<body>

<h2>ðŸ‘€ Game Viewer</h2>

<video id="remoteVideo" autoplay playsinline></video><br>
<button id="shootBtn">ðŸ“¸ Shoot</button>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import { getDatabase, ref, onValue, push } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyCMD_qYKFZQZveZQL1NX7oj3oFuTsRxaYI",
  authDomain: "camera-stream-15427.firebaseapp.com",
  databaseURL: "https://camera-stream-15427-default-rtdb.firebaseio.com",
  projectId: "camera-stream-15427",
  storageBucket: "camera-stream-15427.appspot.com",
  messagingSenderId: "437543558160",
  appId: "1:437543558160:web:32a8d80fdcd95b0568fe95"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const room = "room1";

const pc = new RTCPeerConnection({
  iceServers: [{ urls:"stun:stun.l.google.com:19302" }]
});

const video = document.getElementById("remoteVideo");

pc.ontrack = e => {
  video.srcObject = e.streams[0];
};

pc.onicecandidate = e => {
  if (e.candidate) {
    push(ref(db, room + "/candidates"), e.candidate.toJSON());
  }
};

onValue(ref(db, room + "/offer"), async snap => {
  if (!snap.exists()) return;

  await pc.setRemoteDescription(snap.val());
  const answer = await pc.createAnswer();
  await pc.setLocalDescription(answer);
  await set(ref(db, room + "/answer"), answer);
});

onValue(ref(db, room + "/candidates"), snap => {
  snap.forEach(c => {
    pc.addIceCandidate(new RTCIceCandidate(c.val())).catch(()=>{});
  });
});

// ðŸ“¸ SHOOT & DOWNLOAD
document.getElementById("shootBtn").onclick = () => {
  if (video.readyState < 2) return alert("Video belum siap");

  const canvas = document.createElement("canvas");
  canvas.width = video.videoWidth;
  canvas.height = video.videoHeight;

  const ctx = canvas.getContext("2d");
  ctx.drawImage(video, 0, 0);

  const img = canvas.toDataURL("image/png");

  const a = document.createElement("a");
  a.href = img;
  a.download = "shoot_" + Date.now() + ".png";
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
};
</script>

</body>
</html>
