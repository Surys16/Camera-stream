<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Game Viewer</title>
<style>
  body { display:flex; flex-direction:column; align-items:center; justify-content:center; height:100vh; margin:0; background:#222; color:#fff; }
  video { width:100%; max-width:500px; background:#000; }
  #controls { margin-top:10px; }
  button { margin:0 5px; padding:10px 20px; font-size:16px; cursor:pointer; }
  
  #loadingContainer {
    position:absolute; top:50%; left:50%; transform:translate(-50%, -50%);
    text-align:center;
  }
  #loadingText { font-size:20px; margin-bottom:10px; }
  #loadingBar {
    width:300px; height:20px; background:#555; border-radius:10px; overflow:hidden;
  }
  #loadingProgress {
    height:100%; width:0%; background:#4caf50; transition:width 0.1s;
  }
</style>
</head>
<body>

<div id="loadingContainer">
  <div id="loadingText">Loading video... 0%</div>
  <div id="loadingBar">
    <div id="loadingProgress"></div>
  </div>
</div>

<video id="remoteVideo" autoplay playsinline></video>

<div id="controls">
  <button id="shootBtn">Shoot</button>
  <button id="switchBtn">Switch Camera</button>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import { getDatabase, ref, onValue, push } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";

// ðŸ”¥ Firebase Config
const firebaseConfig = {
  apiKey: "AIzaSyCMD_qYKFZQZveZQL1NX7oj3oFuTsRxaYI",
  authDomain: "camera-stream-15427.firebaseapp.com",
  databaseURL: "https://camera-stream-15427-default-rtdb.firebaseio.com",
  projectId: "camera-stream-15427",
  storageBucket: "camera-stream-15427.firebasestorage.app",
  messagingSenderId: "437543558160",
  appId: "1:437543558160:web:32a8d80fdcd95b0568fe95"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

const room = "room1";
const pc = new RTCPeerConnection({ iceServers: [{ urls: "stun:stun.l.google.com:19302" }] });

const remoteVideo = document.getElementById("remoteVideo");
const loadingContainer = document.getElementById("loadingContainer");
const loadingText = document.getElementById("loadingText");
const loadingProgress = document.getElementById("loadingProgress");
let videoReady = false;

// ðŸ”¹ Simulasi progress 0 â†’ 100%
let progress = 0;
const progressInterval = setInterval(() => {
  if (videoReady || progress >= 100) {
    clearInterval(progressInterval);
    loadingContainer.style.display = "none";
    return;
  }
  progress++;
  loadingText.textContent = `Loading video... ${progress}%`;
  loadingProgress.style.width = progress + "%";
}, 50); // update tiap 50ms

// ðŸ”¹ Video ready
remoteVideo.onloadedmetadata = () => remoteVideo.play();
remoteVideo.onplaying = () => {
  videoReady = true;
  loadingText.textContent = "Video siap!";
  loadingProgress.style.width = "100%";
  setTimeout(() => loadingContainer.style.display = "none", 500);
};

// ðŸ“¥ Terima video
pc.ontrack = e => remoteVideo.srcObject = e.streams[0];

// ðŸ“¤ Kirim ICE candidate
pc.onicecandidate = e => {
  if (e.candidate) push(ref(db, room + "/candidates"), e.candidate.toJSON());
};

// ðŸ“¥ Terima offer dari HP 1
onValue(ref(db, room + "/offer"), async snap => {
  if (!snap.exists()) return;
  await pc.setRemoteDescription(snap.val());
  const answer = await pc.createAnswer();
  await pc.setLocalDescription(answer);
  push(ref(db, room + "/answer"), answer);
});

// ðŸ“¥ Terima ICE candidate
onValue(ref(db, room + "/candidates"), snap => {
  snap.forEach(c => {
    const candidate = new RTCIceCandidate(c.val());
    pc.addIceCandidate(candidate).catch(err => console.warn("ICE candidate add failed:", err));
  });
});

// ðŸ”¹ Shoot
document.getElementById("shootBtn").onclick = () => {
  if (!remoteVideo.srcObject) return alert("Video belum siap!");
  const canvas = document.createElement("canvas");
  canvas.width = remoteVideo.videoWidth;
  canvas.height = remoteVideo.videoHeight;
  canvas.getContext("2d").drawImage(remoteVideo, 0, 0);
  const dataUrl = canvas.toDataURL("image/png");
  const a = document.createElement("a");
  a.href = dataUrl;
  a.download = `shoot_${Date.now()}.png`;
  a.click();
};

// ðŸ”¹ Switch camera
document.getElementById("switchBtn").onclick = () => {
  push(ref(db, room + "/switchCamera"), "toggle");
};

</script>
</body>
</html>
