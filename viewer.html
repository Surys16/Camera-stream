<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Game Viewer</title>
<style>
  body {
    margin:0; font-family: Arial, sans-serif; background:#000; color:#fff;
    display:flex; flex-direction:column; align-items:center; justify-content:flex-start;
    height:100vh;
  }

  /* Video area */
  #videoContainer {
    position: relative; width:100%; max-width:600px;
    background:#000; flex-shrink:0;
  }
  video {
    width:100%; height:auto; display:block;
  }

  /* Loading overlay */
  #loadingContainer {
    position:absolute; top:0; left:0; width:100%; height:100%;
    display:flex; flex-direction:column; justify-content:center; align-items:center;
    background:rgba(0,0,0,0.6); z-index:2;
  }
  #loadingText { font-size:18px; margin-bottom:10px; }
  #loadingBar { width:80%; height:8px; background:#555; border-radius:4px; overflow:hidden; }
  #loadingProgress { height:100%; width:0%; background:#ff0000; transition:width 0.1s; }

  /* Controls like YouTube bottom bar */
  #controls {
    width:100%; max-width:600px; display:flex; justify-content:center; padding:10px;
    background:#111;
    box-shadow:0 -2px 5px rgba(0,0,0,0.5);
  }
  button {
    background:#ff0000; border:none; color:#fff; font-size:16px;
    padding:10px 20px; margin:0 10px; border-radius:4px; cursor:pointer;
  }
  button:hover { background:#e60000; }
</style>
</head>
<body>

<div id="videoContainer">
  <video id="remoteVideo" autoplay playsinline></video>

  <!-- Loading overlay -->
  <div id="loadingContainer">
    <div id="loadingText">Loading video... 0%</div>
    <div id="loadingBar"><div id="loadingProgress"></div></div>
  </div>
</div>

<!-- Controls -->
<div id="controls">
  <button id="shootBtn">Shoot</button>
  <button id="switchBtn">Switch Camera</button>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import { getDatabase, ref, onValue, push } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";

/* ðŸ”¥ Firebase Config */
const firebaseConfig = {
  apiKey: "AIzaSyCMD_qYKFZQZveZQL1NX7oj3oFuTsRxaYI",
  authDomain: "camera-stream-15427.firebaseapp.com",
  databaseURL: "https://camera-stream-15427-default-rtdb.firebaseio.com",
  projectId: "camera-stream-15427",
  storageBucket: "camera-stream-15427.firebasestorage.app",
  messagingSenderId: "437543558160",
  appId: "1:437543558160:web:32a8d80fdcd95b0568fe95"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const room = "room1";

/* DOM Elements */
const remoteVideo = document.getElementById("remoteVideo");
const loadingContainer = document.getElementById("loadingContainer");
const loadingText = document.getElementById("loadingText");
const loadingProgress = document.getElementById("loadingProgress");
const shootBtn = document.getElementById("shootBtn");
const switchBtn = document.getElementById("switchBtn");

/* WebRTC */
const pc = new RTCPeerConnection({ iceServers:[{urls:"stun:stun.l.google.com:19302"}] });

let videoReady = false;
let iceCount = 0;

/* Loading progress helper */
function setProgress(value){
  const pct = Math.min(100,value);
  loadingText.textContent = `Loading video... ${pct}%`;
  loadingProgress.style.width = pct+"%";
}

/* Video events */
remoteVideo.onloadedmetadata = () => remoteVideo.play();
remoteVideo.onplaying = () => {
  videoReady = true;
  setProgress(100);
  setTimeout(()=>loadingContainer.style.display="none",300);
};

/* Track received */
pc.ontrack = e => {
  remoteVideo.srcObject = e.streams[0];
  setProgress(50);
};

/* ICE candidates */
pc.onicecandidate = e => {
  if(e.candidate){
    iceCount++;
    const iceProgress = Math.min(70,30 + iceCount*5);
    setProgress(iceProgress);
    push(ref(db, room+"/candidates"), e.candidate.toJSON());
  }
};

/* Receive offer */
onValue(ref(db, room+"/offer"), async snap=>{
  if(!snap.exists()) return;
  await pc.setRemoteDescription(snap.val());
  const answer = await pc.createAnswer();
  await pc.setLocalDescription(answer);
  push(ref(db, room+"/answer"), answer);
  setProgress(30);
});

/* Receive ICE candidates */
onValue(ref(db, room+"/candidates"), snap=>{
  snap.forEach(c=>{
    const candidate = new RTCIceCandidate(c.val());
    pc.addIceCandidate(candidate).catch(err=>console.warn("ICE candidate add failed:",err));
  });
});

/* Shoot button */
shootBtn.onclick = ()=>{
  if(!remoteVideo.srcObject) return alert("Video belum siap!");
  const canvas = document.createElement("canvas");
  canvas.width = remoteVideo.videoWidth;
  canvas.height = remoteVideo.videoHeight;
  canvas.getContext("2d").drawImage(remoteVideo,0,0);
  const dataUrl = canvas.toDataURL("image/png");

  const a = document.createElement("a");
  a.href = dataUrl;
  a.download = `shoot_${Date.now()}.png`;
  a.click();
};

/* Switch camera */
switchBtn.onclick = ()=> push(ref(db, room+"/switchCamera"),"toggle");

</script>

</body>
</html>
