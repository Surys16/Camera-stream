<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Game Viewer</title>
  <link rel="manifest" href="manifest.json">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="theme-color" content="#111111">
  <style>
    body {
      font-family: sans-serif;
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
      flex-direction: column;
      background: #111;
      color: #fff;
    }
    video {
      width: 90%;
      max-width: 500px;
      border: 2px solid #fff;
      border-radius: 8px;
      margin-bottom: 20px;
    }
  </style>
</head>
<body>
  <h1>Game Viewer</h1>
  <video id="remoteVideo" autoplay playsinline></video>
  <p>Menunggu kamera HP 1...</p>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
    import { getDatabase, ref, set, onValue, push, get, remove } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCMD_qYKFZQZveZQL1NX7oj3oFuTsRxaYI",
      authDomain: "camera-stream-15427.firebaseapp.com",
      databaseURL: "https://camera-stream-15427-default-rtdb.firebaseio.com",
      projectId: "camera-stream-15427",
      storageBucket: "camera-stream-15427.firebasestorage.app",
      messagingSenderId: "437543558160",
      appId: "1:437543558160:web:32a8d80fdcd95b0568fe95"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const room = "room1";
    const pc = new RTCPeerConnection({ iceServers: [{ urls: "stun:stun.l.google.com:19302" }] });

    const remoteVideo = document.getElementById("remoteVideo");
    let answered = false;
    let remoteDescSet = false;
    let iceQueue = [];
    let addedCandidates = new Set();

    pc.onicecandidate = e => {
      if (e.candidate) push(ref(db, room + "/candidates"), e.candidate.toJSON());
    };

    pc.ontrack = e => {
      if (remoteVideo) remoteVideo.srcObject = e.streams[0];
    };

    remove(ref(db, room + "/candidates"));

    const offerRef = ref(db, room + "/offer");

    const checkOffer = async () => {
      try {
        const snap = await get(offerRef);
        if (snap.exists() && !answered) {
          const offer = snap.val();
          await pc.setRemoteDescription(offer);
          const answer = await pc.createAnswer();
          await pc.setLocalDescription(answer);
          set(ref(db, room + "/answer"), { type: answer.type, sdp: answer.sdp });
          answered = true;
          remoteDescSet = true;
          iceQueue.forEach(c => addCandidateSafe(c));
          iceQueue = [];
        }
      } catch (err) {
        console.error("Error creating/sending answer:", err);
      } finally {
        setTimeout(checkOffer, 1000);
      }
    };
    checkOffer();

    const addCandidateSafe = candidate => {
      const key = candidate.candidate + candidate.sdpMid + candidate.sdpMLineIndex;
      if (addedCandidates.has(key)) return;
      pc.addIceCandidate(new RTCIceCandidate(candidate))
        .then(() => addedCandidates.add(key))
        .catch(err => console.warn("ICE candidate failed:", candidate, err));
    };

    onValue(ref(db, room + "/candidates"), snap => {
      snap.forEach(c => {
        const candidate = c.val();
        if (!candidate) return;
        if (remoteDescSet) addCandidateSafe(candidate);
        else iceQueue.push(candidate);
      });
    });

    // ---------- Register service worker ----------
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('service-worker.js')
        .then(() => console.log("Service Worker registered"))
        .catch(err => console.error("SW registration failed:", err));
    }
  </script>
</body>
</html>
